<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Kambo Klarity Registration</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Manrope%3Awght%40400%3B500%3B700%3B800&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <!-- Calendar Theme CSS -->
    <link rel="stylesheet" href="calendar-theme.css" />
    <!-- Stagewise Development Toolbar (development only) -->
    <script type="module" src="stagewise-working.js"></script>
  </head>
  <body style='font-family: Manrope, "Noto Sans", sans-serif;'>
    <!-- Video Background -->
    <video class="video-background" autoplay muted loop playsinline>
      <source src="backgroundVideo.mov" type="video/quicktime">
      <source src="backgroundVideo.webm" type="video/webm">
      <source src="backgroundVideo.mp4" type="video/mp4">
      <!-- Fallback for browsers that don't support video -->
      Your browser does not support the video tag.
    </video>
    
    <div class="relative min-h-screen p-4">
      <div class="form-container max-w-lg mx-auto p-6">
        <span class="frog-emoji">üê∏</span>
        <h1 class="text-center mb-6 text-3xl font-bold">Kambo Klarity Registration</h1>

        <form id="registrationForm" action="/submit-registration" method="POST">
          <!-- Hidden field to store Telegram User ID -->
          <input type="hidden" id="telegramId" name="telegramId" />

          <div class="form-group">
            <label for="firstName">First Name</label>
            <input
              type="text"
              id="firstName"
              name="firstName"
              class="form-control"
              required
              aria-required="true"
            />
            <div class="error" id="firstNameError">
              Please enter your first name
            </div>
          </div>

          <div class="form-group">
            <label for="lastName">Last Name</label>
            <input
              type="text"
              id="lastName"
              name="lastName"
              class="form-control"
              required
              aria-required="true"
            />
            <div class="error" id="lastNameError">
              Please enter your last name
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-control"
              required
              aria-required="true"
            />
            <div class="error" id="emailError">
              Please enter a valid email address
            </div>
          </div>

          <div class="form-group">
            <label for="phoneNumber">Phone Number</label>
            <input
              type="tel"
              id="phoneNumber"
              name="phoneNumber"
              class="form-control"
              required
              aria-required="true"
            />
            <div class="error" id="phoneNumberError">
              Please enter a valid phone number
            </div>
          </div>

          <div class="form-group">
            <label for="dateOfBirth">Date of Birth</label>
            <input
              type="date"
              id="dateOfBirth"
              name="dateOfBirth"
              class="form-control"
              required
              aria-required="true"
            />
            <div class="error" id="dateOfBirthError">
              Please enter your date of birth
            </div>
            <div class="hint">Must be at least 18 years old</div>
          </div>

          <div class="form-group">
            <label for="reasonForSeeking">Reason for Seeking Kambo</label>
            <textarea
              id="reasonForSeeking"
              name="reasonForSeeking"
              class="form-control"
              required
              aria-required="true"
              rows="4"
            ></textarea>
            <div class="error" id="reasonForSeekingError">
              Please share your reason for seeking Kambo
            </div>
            <div class="hint">
              Please share any health concerns or goals you have for your Kambo
              journey
            </div>
          </div>

          <div class="form-group">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="isVeteranOrResponder"
                name="is_veteran_or_responder"
                value="true"
              />
              <label class="form-check-label" for="isVeteranOrResponder">
                I identify as a Military Veteran or First Responder. (Optional)
              </label>
            </div>
            <div class="hint">
              Checking this box helps us tailor potential future programs and
              offers.
            </div>
          </div>

          <button type="submit" class="btn-primary h-12 text-base font-bold disabled:opacity-50 disabled:cursor-not-allowed" id="submitButton">
            Submit Registration
          </button>
        </form>
      </div>
    </div>

    <script>
      // [INIT NODE] Initialize Telegram WebApp
      console.log("[INIT NODE] Starting Telegram WebApp initialization...");
      const tg = window.Telegram.WebApp;
      tg.expand();
      tg.enableClosingConfirmation();
      console.log("[INIT NODE] Telegram WebApp initialized successfully");

      // [THEME NODE] Apply Telegram theme variables dynamically
      console.log("[THEME NODE] Applying theme variables...");
      const root = document.documentElement;
      if (tg.themeParams) {
        root.style.setProperty(
          "--tg-theme-bg-color",
          tg.themeParams.bg_color || "#ffffff",
        );
        root.style.setProperty(
          "--tg-theme-text-color",
          tg.themeParams.text_color || "#000000",
        );
        root.style.setProperty(
          "--tg-theme-hint-color",
          tg.themeParams.hint_color || "#999999",
        );
        root.style.setProperty(
          "--tg-theme-link-color",
          tg.themeParams.link_color || "#2481cc",
        );
        root.style.setProperty(
          "--tg-theme-button-color",
          tg.themeParams.button_color || "#5fb13d",
        );
        root.style.setProperty(
          "--tg-theme-button-text-color",
          tg.themeParams.button_text_color || "#ffffff",
        );
        root.style.setProperty(
          "--tg-theme-secondary-bg-color",
          tg.themeParams.secondary_bg_color ||
            (tg.colorScheme === "dark" ? "#2c2c2e" : "#f2f2f7"),
        );
        console.log(
          "[THEME NODE] Theme variables applied from Telegram params",
        );
      } else {
        console.log(
          "[THEME NODE] No Telegram theme params available, using defaults",
        );
      }

      // [FORM NODE] Form validation and submission
      console.log("[FORM NODE] Setting up form validation and submission...");
      const form = document.getElementById("registrationForm");
      const submitButton = document.getElementById("submitButton");

      form.addEventListener("submit", function (event) {
        event.preventDefault();
        console.log("[FORM NODE] Form submission initiated");

        if (validateForm()) {
          console.log("[FORM NODE] Form validation successful, preparing data");
          submitButton.disabled = true;
          submitButton.textContent = "Submitting...";

          const formData = {
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            email: document.getElementById("email").value,
            phoneNumber: document.getElementById("phoneNumber").value,
            dateOfBirth: document.getElementById("dateOfBirth").value,
            reasonForSeeking: document.getElementById("reasonForSeeking").value,
            is_veteran_or_responder: document.getElementById("isVeteranOrResponder").checked,
            telegramId: document.getElementById("telegramId").value,
          };

          console.log("[FORM NODE] FormData to be sent:", formData);

          console.log("[FORM NODE] Sending data to server");
          // Add the telegramId to the formData before submission

          // ---> Use the botServerUrl from the query parameter <--- //
          function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
          }
          const botServerUrl = getQueryParam("botServerUrl");
          const submitUrl = `${botServerUrl}/submit-registration`;
          console.log(`[FORM NODE] Submitting to absolute URL: ${submitUrl}`);

          fetch(submitUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("[FORM NODE] Form submission response:", data);
              if (data.success) {
                tg.close(); // Close WebApp on successful submission
              } else {
                alert("Submission failed: " + data.message);
                submitButton.disabled = false;
                submitButton.textContent = "Submit Registration";
              }
            })
            .catch((error) => {
              console.error("[FORM NODE] Error submitting form:", error);
              submitButton.disabled = false; // Re-enable button on error
              submitButton.textContent = "Submit Registration";
              // Display an error message to the user within the form
              alert(
                "Failed to submit registration. Please try again. Error: " +
                  error.message,
              );
            });
        } else {
          console.log("[FORM NODE] Form validation failed");
        }
      });

      function validateForm() {
        console.log("[VALIDATION NODE] Starting form validation");
        let isValid = true;

        // Function to show/hide error with proper accessibility attributes
        function toggleError(input, errorElement, isInvalid, message) {
          if (isInvalid) {
            errorElement.textContent = message;
            errorElement.style.display = "block";
            input.setAttribute("aria-invalid", "true");
            input.setAttribute("aria-describedby", errorElement.id);
            isValid = false;
          } else {
            errorElement.style.display = "none";
            input.setAttribute("aria-invalid", "false");
            input.removeAttribute("aria-describedby");
          }
        }

        // First Name validation
        const firstName = document.getElementById("firstName");
        const firstNameError = document.getElementById("firstNameError");
        toggleError(
          firstName,
          firstNameError,
          !firstName.value.trim(),
          "Please enter your first name",
        );

        // Last Name validation
        const lastName = document.getElementById("lastName");
        const lastNameError = document.getElementById("lastNameError");
        toggleError(
          lastName,
          lastNameError,
          !lastName.value.trim(),
          "Please enter your last name",
        );

        // Email validation
        const email = document.getElementById("email");
        const emailError = document.getElementById("emailError");
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        toggleError(
          email,
          emailError,
          !emailRegex.test(email.value),
          "Please enter a valid email address",
        );

        // Phone validation
        const phoneNumber = document.getElementById("phoneNumber");
        const phoneNumberError = document.getElementById("phoneNumberError");
        toggleError(
          phoneNumber,
          phoneNumberError,
          !phoneNumber.value.trim(),
          "Please enter a valid phone number",
        );

        // Date of Birth validation
        const dateOfBirth = document.getElementById("dateOfBirth");
        const dateOfBirthError = document.getElementById("dateOfBirthError");

        if (!dateOfBirth.value) {
          toggleError(
            dateOfBirth,
            dateOfBirthError,
            true,
            "Please enter your date of birth",
          );
        } else {
          // Check if user is at least 18 years old
          const birthDate = new Date(dateOfBirth.value);
          const today = new Date();
          let age = today.getFullYear() - birthDate.getFullYear();
          const monthDiff = today.getMonth() - birthDate.getMonth();

          if (
            monthDiff < 0 ||
            (monthDiff === 0 && today.getDate() < birthDate.getDate())
          ) {
            age--;
          }

          toggleError(
            dateOfBirth,
            dateOfBirthError,
            age < 18,
            "You must be at least 18 years old",
          );
        }

        // Reason validation
        const reasonForSeeking = document.getElementById("reasonForSeeking");
        const reasonForSeekingError = document.getElementById(
          "reasonForSeekingError",
        );
        toggleError(
          reasonForSeeking,
          reasonForSeekingError,
          !reasonForSeeking.value.trim(),
          "Please share your reason for seeking Kambo",
        );

        console.log(
          "[VALIDATION NODE] Form validation complete, isValid:",
          isValid,
        );
        return isValid;
      }

      // [USER DATA NODE] Pre-fill form with user data if available
      // Also handles populating the hidden telegramId field.
      console.log("[USER DATA NODE] Checking for user data to pre-fill form");
      const telegramIdInput = document.getElementById("telegramId");

      // Function to get URL query parameters
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      let userId = null;

      // Try getting ID from Telegram environment first
      if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
        userId = tg.initDataUnsafe.user.id;
        console.log("[USER DATA NODE] Found Telegram ID via Telegram WebApp:", userId);

        // Pre-fill name fields if available from Telegram
        const user = tg.initDataUnsafe.user;
        if (user.first_name) {
          document.getElementById("firstName").value = user.first_name;
          console.log(
            "[USER DATA NODE] Pre-filled first name:",
            user.first_name,
          );
        }
        if (user.last_name) {
          document.getElementById("lastName").value = user.last_name;
          console.log("[USER DATA NODE] Pre-filled last name:", user.last_name);
        }
      } else {
         // Fallback: Try getting ID from URL query parameter
        userId = getQueryParam("telegramId");
        if (userId) {
          console.log("[USER DATA NODE] Found Telegram ID via URL parameter:", userId);
        } else {
          console.warn("[USER DATA NODE] Could not find Telegram ID from WebApp or URL.");
        }
      }

      // Populate the hidden field if we found an ID
      if (telegramIdInput && userId) {
        telegramIdInput.value = userId;
        console.log("[USER DATA NODE] Set hidden telegramId field:", userId);
      } else if (!telegramIdInput) {
        console.error(
          "[USER DATA NODE] Critical: Could not find hidden telegramId input field!",
        );
      } else {
         console.warn("[USER DATA NODE] Hidden telegramId field remains empty.");
      }

    </script>
    <script>
      // ======================================================================
      // [NODE_TYPE: FORM_INIT_NODE]
      // ======================================================================
      // Purpose: Initialize form and handle Telegram ID validation
      // Input: DOM elements
      // Output: Validated form state
      (function () {
        console.log("[FORM_INIT_NODE] Starting form initialization...");
        // Ensure Telegram ID is set before allowing submission
        const form = document.getElementById("registrationForm");
        const submitButton = document.getElementById("submitButton");
        const telegramIdInput = document.getElementById("telegramId");

        if (!telegramIdInput || !telegramIdInput.value) {
          console.warn(
            "[FORM_INIT_NODE] Telegram ID not pre-filled. Disabling submit until ID is available.",
          );
          // if (submitButton) submitButton.disabled = true; // <<< COMMENTED OUT
          // Potentially show a message to the user
        }
        console.log("[FORM_INIT_NODE] Form initialization complete");
      })();

      // ======================================================================
      // [NODE_TYPE: KEYBOARD_CONTROL_NODE]
      // ======================================================================
      // Purpose: Handle keyboard dismissal using modern web APIs
      // Input: Touch events, VisualViewport events
      // Output: Keyboard visibility control
      (function () {
        console.log(
          "[KEYBOARD_CONTROL_NODE] Setting up keyboard dismissal behavior...",
        );

        // 1. Blur any focused field on downward scroll so the keyboard collapses
        let lastY = 0;
        window.addEventListener("touchstart", (e) => {
          console.log("[KEYBOARD_CONTROL_NODE] Touch start detected");
          lastY = e.touches[0].clientY;
        });

        window.addEventListener("touchmove", (e) => {
          if (e.touches[0].clientY > lastY + 12) {
            // dragging down
            console.log(
              "[KEYBOARD_CONTROL_NODE] Downward drag detected, blurring active element",
            );
            document.activeElement?.blur(); // hides KB on both iOS/Android
          }
        });

        // 2. Use VisualViewport to adjust UI when the KB is visible
        if (window.visualViewport) {
          console.log(
            "[KEYBOARD_CONTROL_NODE] VisualViewport API available, setting up resize listener",
          );
          visualViewport.addEventListener("resize", () => {
            const kbHeight = window.innerHeight - visualViewport.height;
            document.body.style.setProperty("--kb", kbHeight + "px");
            console.log(
              `[KEYBOARD_CONTROL_NODE] Keyboard height: ${kbHeight}px`,
            );
          });
        } else {
          console.log(
            "[KEYBOARD_CONTROL_NODE] VisualViewport API not available",
          );
        }

        console.log(
          "[KEYBOARD_CONTROL_NODE] Keyboard dismissal setup complete",
        );
      })();
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kambo Waiver Form</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/waiver-form.css" />
  </head>
  <body>
    <div class="container">
      <div class="frog-emoji">üê∏</div>
      <h1 class="text-center mb-4">
        Kambo Preparation, Contra-Indications & Liability Form
      </h1>

      <div id="appointmentInfo" class="alert alert-success mb-4">
        <h5>Your Appointment Details:</h5>
        <p id="appointmentDateTime">Loading appointment details...</p>
        <p id="sessionType">Loading session type...</p>
      </div>

      <form id="waiverForm" novalidate>
        <input type="hidden" id="telegramId" name="telegramId" />
        <input
          type="hidden"
          id="appointmentDateTimeValue"
          name="appointmentDateTime"
        />
        <input type="hidden" id="sessionTypeValue" name="sessionType" />

        <!-- Section 1: Things to avoid -->
        <div class="section">
          <h3>1. Things that must be avoided before Kambo</h3>
          <ul>
            <li>Immune suppressants for auto-immune disorders</li>
            <li>Slimming or sleeping supplements (including melatonin)</li>
            <li>Alcohol or drugs 24 hours before and after</li>
            <li>
              Fasting longer than 18 hours within 7 days before or after Kambo
              (includes juice fasts)
            </li>
            <li>
              Sweat-lodges, colonics, enemas, liver flushes or any water-based
              detox within 3 days either side of Kambo
            </li>
          </ul>
          <div class="form-check mt-3">
            <label class="form-check-label" for="avoidAgreement">
              Please confirm you have read and understood the above precautions.
            </label>
            <input
              class="form-check-input"
              type="checkbox"
              id="avoidAgreement"
              required
            />
          </div>
        </div>

        <!-- Section 2: Absolute Contra-Indications -->
        <div class="section">
          <h3>2. Absolute Contra-Indications</h3>
          <p>
            You should not participate in a Kambo treatment if any of the
            following apply. <strong>Please check all that apply:</strong>
          </p>
          <ul style="list-style: none; padding-left: 0">
            <li>
              Serious heart problems
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="heart"
                />
              </div>
            </li>
            <li>
              On a no-salt diet or have been on one in the past two weeks
              (ayahuasca diet)
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="nosalt"
                />
              </div>
            </li>
            <li>
              Ehlers-Danlos syndrome
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="ehlers"
                />
              </div>
            </li>
            <li>
              Marfan syndrome
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="marfan"
                />
              </div>
            </li>
            <li>
              Medication for low blood pressure
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="lowbpmed"
                />
              </div>
            </li>
            <li>
              Stroke, brain haemorrhage, aneurism or blood clots
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="stroke"
                />
              </div>
            </li>
            <li>
              Lacking capacity to decide on Kambo
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="capacity"
                />
              </div>
            </li>
            <li>
              Serious mental-health problems (excludes depression, PTSD,
              anxiety)
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="mentalhealth"
                />
              </div>
            </li>
            <li>
              Undergoing chemo-, radio- or immuno-therapy (less than 6 weeks
              post-treatment)
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="chemo"
                />
              </div>
            </li>
            <li>
              Immune-suppressants following organ transplant
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="immunesuppress"
                />
              </div>
            </li>
            <li>
              Addison's disease
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="addison"
                />
              </div>
            </li>
            <li>
              Current and severe epilepsy
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="epilepsy"
                />
              </div>
            </li>
            <li>
              Major surgical recovery
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="surgery"
                />
              </div>
            </li>
            <li>
              Under 18 years old
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="under18"
                />
              </div>
            </li>
            <li>
              Bufo ceremony in last 6 weeks
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="bufo"
                />
              </div>
            </li>
            <li>
              Pregnant / possibly pregnant / breast-feeding
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="pregnant"
                />
              </div>
            </li>
            <li>
              Daily diuretic use (unless cleared by practitioner)
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="diuretic"
                />
              </div>
            </li>
            <li>
              Other strong medicines (San Pedro, Ayahuasca, Mushrooms) within 24
              h
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="othermeds"
                />
              </div>
            </li>
            <li>
              Age greater than or equal to 70 years
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="age70"
                />
              </div>
            </li>
            <li>
              Large volumes of water immediately before session
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="water"
                />
              </div>
            </li>
            <li>
              Fasting greater than 18 hours before session
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="fasting"
                />
              </div>
            </li>
            <li>
              Covid vaccine within last 4 weeks
              <div class="form-check mt-1">
                <input
                  type="checkbox"
                  class="form-check-input"
                  name="contraindications"
                  value="covid"
                />
              </div>
            </li>
          </ul>
          <div class="hint">
            You must check each box that applies to you. If none apply, check
            none.
          </div>
        </div>

        <!-- Section 3: Substance Guidelines -->
        <div class="section">
          <h3>3. Substance Guideline List</h3>
          <p>(Minimum abstinence periods - prior to / after Kambo)</p>

          <div class="table-responsive">
            <table class="table table-striped table-sm substance-table">
              <thead>
                <tr>
                  <th>Substance</th>
                  <th>Prior</th>
                  <th>Post</th>
                  <th>Agreement</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Alcohol ‚Äì high doses</td>
                  <td>48 h</td>
                  <td>7 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Alcohol ‚Äì low doses</td>
                  <td>12 h</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Amphetamines (Adderall, Ritalin)</td>
                  <td>7 days</td>
                  <td>7 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    Anti-depressants & anxiety meds (e.g., Duloxetine/Cymbalta)
                  </td>
                  <td>Do not take morning of / 2 h</td>
                  <td></td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Anti-convulsants ‚Äì must discuss with facilitator</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Anti-epileptics</td>
                  <td>CONTRA-INDICATED</td>
                  <td></td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Anti-psychotics</td>
                  <td>CONTRA-INDICATED</td>
                  <td></td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Ayahuasca & analogues*</td>
                  <td>24 h</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Benzodiazepines (Valium, Diazepam)</td>
                  <td>18 h</td>
                  <td>8 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Beta-blockers</td>
                  <td>Do not take morning of</td>
                  <td>8 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Blood thinners</td>
                  <td>Do not take morning of</td>
                  <td>8 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Botox</td>
                  <td>7 days</td>
                  <td>7 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Bufo / 5-MeO-DMT</td>
                  <td>6 weeks</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Cannabis</td>
                  <td>12 h</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Cocaine</td>
                  <td>3 days</td>
                  <td>5 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Codeine</td>
                  <td>24 h</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Crack cocaine</td>
                  <td>7 days</td>
                  <td>7 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Ecstasy (MDMA) / other MD**</td>
                  <td>7 days</td>
                  <td>7 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Fentanyl</td>
                  <td>CONTRA-INDICATED</td>
                  <td></td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>GHB</td>
                  <td>7 days</td>
                  <td>7 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Heroin (recreational)</td>
                  <td>14 days</td>
                  <td>14 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    Heroin substitutes (Methadone, Buprenorphine, Naltrexone)
                  </td>
                  <td>CONTRA-INDICATED</td>
                  <td></td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>High-blood-pressure meds</td>
                  <td>Do not take morning of</td>
                  <td>8 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Iboga</td>
                  <td>90 days</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Ibogaine</td>
                  <td>10 days</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Ketamine</td>
                  <td>3 days</td>
                  <td>3 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>LSD</td>
                  <td>48 h</td>
                  <td>72 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Meth-amphetamine</td>
                  <td>30 days</td>
                  <td>30 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Morphine / Oxycodone</td>
                  <td>5 days</td>
                  <td>5 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>N, N-DMT</td>
                  <td>8 h</td>
                  <td>8 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Peyote / San Pedro (Mescaline)</td>
                  <td>24 h</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Psilocybin</td>
                  <td>24 h</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Tramadol</td>
                  <td>48 h</td>
                  <td>24 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Vasoconstrictors (Triptans)</td>
                  <td>3 days</td>
                  <td>12 h</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Covid vaccine or booster</td>
                  <td>30 days</td>
                  <td>7 days</td>
                  <td>
                    <div class="form-check">
                      <input
                        class="form-check-input substance-check"
                        type="checkbox"
                      />
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="form-text">* Only if not on a no-salt diet.</p>
          <div class="form-check mt-3">
            <label class="form-check-label" for="substanceAgreement">
              Please confirm you have read and understood the substance
              guidelines.
            </label>
            <input
              class="form-check-input"
              type="checkbox"
              id="substanceAgreement"
              required
            />
          </div>
        </div>

        <!-- Section 4: Release of Liability -->
        <div class="section">
          <h3>
            4. Kambo Klarity ‚Äì "Kambo Session" Release of Liability & Assumption
            of Risk
          </h3>
          <p>
            <strong>Disclaimer</strong> ‚Äì Kambo is the sweat from the
            Phyllomedusa bicolor frog. It is not a drug, medicine, or controlled
            substance. It is a natural substance that has been used by
            indigenous tribes in the Amazon for centuries for hunting and to
            treat various health conditions. Kambo Klarity does not provide
            medical advice, diagnosis, or treatment. The information provided is
            for educational purposes only.
          </p>

          <p>
            <strong
              >In consideration for being allowed to participate I agree to the
              following:</strong
            >
          </p>

          <ol type="a">
            <li>
              <strong>Agreement to follow directions</strong> ‚Äì I will comply
              with all instructions of Kambo Klarity practitioners.
            </li>
            <li>
              <strong>Assumption of risks & release</strong> ‚Äì If acute adverse
              effects occur I will call 911. I accept full responsibility and
              release Kambo Klarity from liability. Possible side-effects
              include:
              <ol type="1">
                <li>Increased heart rate</li>
                <li>Flushing of the skin</li>
                <li>Slight pressure in the head</li>
                <li>Numbness/tingling</li>
                <li>
                  'Flu-like' symptoms (nausea, chills, abdominal cramping)
                </li>
                <li>Tetany</li>
              </ol>
            </li>
            <li>
              <strong>Fees</strong> ‚Äì I will pay for any damage I cause to
              facilities used.
            </li>
            <li>
              <strong>Applicable law</strong> ‚Äì Texas law governs this
              Agreement.
            </li>
            <li>
              <strong>No duress</strong> ‚Äì I sign voluntarily and had
              opportunity to consult legal counsel; fees would be refunded if I
              elected not to sign.
            </li>
            <li>
              <strong>Arm's length agreement</strong> ‚Äì Both parties negotiated
              this document; no clause shall be construed for/against its
              drafter.
            </li>
            <li>
              <strong>Enforceability</strong> ‚Äì Invalid provisions do not affect
              the remainder of the Agreement.
            </li>
            <li>
              <strong>Dispute resolution</strong> ‚Äì Friendly negotiation, then
              binding arbitration under the American Arbitration Association.
            </li>
            <li>
              <strong>Indemnification</strong> ‚Äì I release, indemnify and hold
              harmless the organiser, practitioner and related parties from any
              and all liability, even if arising from their negligence.
            </li>
          </ol>

          <div class="form-check mt-3">
            <label class="form-check-label" for="liabilityAgreement">
              Please confirm you fully understand that signing this release
              means you voluntarily surrender certain legal rights.
            </label>
            <input
              class="form-check-input"
              type="checkbox"
              id="liabilityAgreement"
              required
            />
          </div>
        </div>

        <!-- Section 5: Participant Information -->
        <div class="section">
          <h3>5. Participant Information</h3>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="firstName" class="form-label required-field"
                >First Name</label
              >
              <input
                type="text"
                class="form-control"
                id="firstName"
                name="firstName"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="lastName" class="form-label required-field"
                >Last Name</label
              >
              <input
                type="text"
                class="form-control"
                id="lastName"
                name="lastName"
                required
              />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="phone" class="form-label required-field">Phone</label>
              <input
                type="tel"
                class="form-control"
                id="phone"
                name="phone"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="dob" class="form-label required-field"
                >Date of Birth</label
              >
              <input
                type="date"
                class="form-control"
                id="dob"
                name="dob"
                required
              />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="email" class="form-label required-field"
                >Email Address</label
              >
              <input
                type="email"
                class="form-control"
                id="email"
                name="email"
                required
              />
            </div>
            <div class="col-md-6"></div>
          </div>

          <h4>Emergency Contact</h4>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="emergencyFirstName" class="form-label required-field"
                >First Name</label
              >
              <input
                type="text"
                class="form-control"
                id="emergencyFirstName"
                name="emergencyFirstName"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="emergencyLastName" class="form-label required-field"
                >Last Name</label
              >
              <input
                type="text"
                class="form-control"
                id="emergencyLastName"
                name="emergencyLastName"
                required
              />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="emergencyPhone" class="form-label required-field"
                >Phone</label
              >
              <input
                type="tel"
                class="form-control"
                id="emergencyPhone"
                name="emergencyPhone"
                required
              />
            </div>
          </div>
        </div>

        <!-- Section 7: Electronic Signature -->
        <div class="section">
          <h3>7. Electronic Signature Consent</h3>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="electronicSignature"
              name="electronicSignature"
              required
            />
            <label class="form-check-label" for="electronicSignature">
              By checking here, I consent to use my electronic signature in lieu
              of an original paper signature. I waive the right to sign a paper
              copy, but may request one later at no cost. My consent will remain
              in force until I notify Kambo Klarity in writing that I wish to
              withdraw it. I understand there is no penalty for withdrawal and
              that I must keep my email address current for updates.
            </label>
          </div>

          <div class="mt-2">
            <label for="signature" class="form-label required-field"
              >Type your full name to sign electronically</label
            >
            <input
              type="text"
              class="form-control"
              id="signature"
              name="signature"
              required
            />
          </div>
          <div class="form-group" style="margin-top: 12px">
            <button type="submit" id="submitButton" class="button">
              Submit Waiver Form
            </button>
            <style>
              .spinner {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
                margin-right: 8px;
                vertical-align: middle;
              }
              @keyframes spin {
                to {
                  transform: rotate(360deg);
                }
              }
            </style>
          </div>
        </div>
      </form>
    </div>

    <script>
      // Initialize Telegram WebApp
      const tgApp = window.Telegram.WebApp;
      tgApp.expand();
      tgApp.ready();

      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const telegramId = urlParams.get("telegramId");
      const sessionType = urlParams.get("sessionType");

      // Set hidden fields
      document.getElementById("telegramId").value = telegramId;
      document.getElementById("sessionTypeValue").value = sessionType;
      document.getElementById("sessionType").textContent =
        `Session Type: ${sessionType}`;

      // Fetch user data
      fetch(`/api/user-data?telegramId=${telegramId}`)
        .then((response) => response.json())
        .then((data) => {
          // ======================================================================
          // [NODE_TYPE: DEBUG_DATA_NODE]
          // ======================================================================
          // Purpose: Debug the data coming from server
          // Input: API response data
          // Output: Logged data for debugging
          console.log(`üîÑ [waiver-form/debug] Complete user data:`, data);
          console.log(
            `üîÑ [waiver-form/debug] Appointment value:`,
            data.appointmentDateTime,
          );
          console.log(`üîÑ [waiver-form/debug] Phone value:`, data.phone);

          // ======================================================================
          // [NODE_TYPE: FORM_FILL_NODE]
          // ======================================================================
          // Purpose: Fill form with user data
          // Input: User data from API
          // Output: Updated form fields

          // ======================================================================
          // [NODE_TYPE: FORM_AUTO_POPULATION_NODE]
          // ======================================================================
          // Purpose: Auto-populate form fields with user data
          // Input: User data from API
          // Output: Filled form fields
          console.log(
            "[FORM_AUTO_POPULATION_NODE] Auto-populating form fields",
          );

          // Fill in user data
          document.getElementById("firstName").value = data.firstName || "";
          document.getElementById("lastName").value = data.lastName || "";
          document.getElementById("email").value = data.email || "";
          document.getElementById("dob").value = data.dob || "";
          document.getElementById("phone").value = data.phone || "";

          // Auto-populate emergency contact fields if available
          if (
            data.emergencyFirstName ||
            data.emergencyLastName ||
            data.emergencyPhone
          ) {
            console.log(
              "[FORM_AUTO_POPULATION_NODE] Auto-populating emergency contact fields",
            );
            document.getElementById("emergencyFirstName").value =
              data.emergencyFirstName || "";
            document.getElementById("emergencyLastName").value =
              data.emergencyLastName || "";
            document.getElementById("emergencyPhone").value =
              data.emergencyPhone || "";
          }

          // Display appointment date formatted by server
          if (data.appointmentDateTime) {
            const apptText = `Appointment: ${data.appointmentDateTime}`;
            document.getElementById("appointmentDateTime").textContent =
              apptText;
            console.log(
              `‚úÖ [waiver-form/debug] Set appointment text to: "${apptText}"`,
            );
          } else {
            document.getElementById("appointmentDateTime").textContent =
              "No appointment scheduled";
            console.log(
              `‚ö†Ô∏è [waiver-form/debug] No appointment date found in data`,
            );
          }
          // Use raw ISO timestamp for form submission
          document.getElementById("appointmentDateTimeValue").value =
            data.rawAppointmentDateTime || "";
        })
        .catch((error) => {
          console.error("Error fetching user data:", error);
          tgApp.showAlert("Error loading user data. Please try again.");
        });

      // ======================================================================
      // [NODE_TYPE: VALIDATION_SETUP]
      // ======================================================================
      // Purpose: Limit required checkboxes to only confirm fields
      const checkboxConfirmIds = [
        "avoidAgreement",
        "substanceAgreement",
        "liabilityAgreement",
        "electronicSignature",
      ];
      document.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
        if (!checkboxConfirmIds.includes(cb.id)) {
          cb.removeAttribute("required");
        }
      });

      // ======================================================================
      // [NODE_TYPE: KEYBOARD_CONTROL_NODE]
      // ======================================================================
      // Purpose: Handle keyboard dismissal using modern web APIs
      // Input: Touch events, VisualViewport events
      // Output: Keyboard visibility control
      console.log(
        "[KEYBOARD_CONTROL_NODE] Setting up keyboard dismissal behavior...",
      );

      // 1. Blur any focused field on downward scroll so the keyboard collapses
      let lastY = 0;
      window.addEventListener("touchstart", (e) => {
        console.log("[KEYBOARD_CONTROL_NODE] Touch start detected");
        lastY = e.touches[0].clientY;
      });

      window.addEventListener("touchmove", (e) => {
        if (e.touches[0].clientY > lastY + 12) {
          // dragging down
          console.log(
            "[KEYBOARD_CONTROL_NODE] Downward drag detected, blurring active element",
          );
          document.activeElement?.blur(); // hides KB on both iOS/Android
        }
      });

      // 2. Use VisualViewport to adjust UI when the KB is visible
      if (window.visualViewport) {
        console.log(
          "[KEYBOARD_CONTROL_NODE] VisualViewport API available, setting up resize listener",
        );
        visualViewport.addEventListener("resize", () => {
          const kbHeight = window.innerHeight - visualViewport.height;
          document.body.style.setProperty("--kb", kbHeight + "px");
          console.log(`[KEYBOARD_CONTROL_NODE] Keyboard height: ${kbHeight}px`);
        });
      } else {
        console.log("[KEYBOARD_CONTROL_NODE] VisualViewport API not available");
      }

      console.log("[KEYBOARD_CONTROL_NODE] Keyboard dismissal setup complete");

      // ======================================================================
      // [NODE_TYPE: FORM_SUBMISSION_NODE]
      // ======================================================================
      // Purpose: Handle form submission and validation
      // Input: Form data from user
      // Output: Validated data sent to server or validation errors
      document
        .getElementById("submitButton")
        .addEventListener("click", function (event) {
          // Prevent default form submission which would cause page reload
          event.preventDefault();
          console.log("[FORM_SUBMISSION_NODE] Submit button clicked");
          const form = document.getElementById("waiverForm");

          // ======================================================================
          // [NODE_TYPE: VALIDATION_NODE]
          // ======================================================================
          // Purpose: Validate required fields and highlight errors
          document
            .querySelectorAll(".error-outline")
            .forEach((el) => el.classList.remove("error-outline"));
          document
            .querySelectorAll(".error-message.visible")
            .forEach((el) => el.classList.remove("visible"));

          let isValid = true;
          let firstInvalidElement = null;

          form.querySelectorAll("input[required]").forEach((el) => {
            if (
              (el.type === "checkbox" && !el.checked) ||
              (el.type !== "checkbox" && !el.value.trim())
            ) {
              el.classList.add("error-outline");

              // Find the closest parent with form-group class or create error message
              let container;
              if (el.type === "checkbox") {
                container = el.closest(".form-check");
              } else {
                container =
                  el.closest(".col-md-6") ||
                  el.closest(".form-group") ||
                  el.parentElement;
              }

              // Find existing error message or create one
              let errorMsg = container.querySelector(".error-message");
              if (!errorMsg) {
                errorMsg = document.createElement("div");
                errorMsg.className = "error-message";
                errorMsg.textContent = "Required to submit";
                container.appendChild(errorMsg);
              }

              errorMsg.classList.add("visible");

              // Store first invalid element for scrolling
              if (!firstInvalidElement) {
                firstInvalidElement = el;
              }

              isValid = false;
            }
          });

          if (!isValid) {
            console.log(
              "[VALIDATION_NODE] Validation failed, highlighting errors",
            );

            // Scroll to the first invalid element with smooth behavior
            if (firstInvalidElement) {
              firstInvalidElement.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });

              // Focus the element after scrolling
              setTimeout(() => {
                firstInvalidElement.focus();
              }, 500);
            }

            return;
          }

          // Collect form data
          const formData = new FormData(form);
          const formDataObj = {};
          formData.forEach((value, key) => {
            formDataObj[key] = value;
          });

          // ======================================================================
          // [NODE_TYPE: DATA_COLLECTION_NODE]
          // ======================================================================
          // Purpose: Collect all form data including checkbox descriptions
          // Input: Form elements
          // Output: Structured form data object with descriptions
          console.log(
            "[DATA_COLLECTION_NODE] Collecting form data with descriptions",
          );

          // Add contraindications with descriptions
          const contraindications = [];
          document
            .querySelectorAll('input[name="contraindications"]')
            .forEach((checkbox) => {
              const label = checkbox.closest("li").textContent.trim();
              contraindications.push({
                description: label,
                checked: checkbox.checked,
              });
            });
          formDataObj.contraindications = contraindications;

          // Add substance agreements with descriptions
          const substanceAgreements = [];
          document.querySelectorAll(".substance-check").forEach((checkbox) => {
            const row = checkbox.closest("tr");
            if (row) {
              const cells = row.querySelectorAll("td");
              if (cells.length >= 3) {
                substanceAgreements.push({
                  substance: cells[0].textContent.trim(),
                  prior: cells[1].textContent.trim(),
                  post: cells[2].textContent.trim(),
                  checked: checkbox.checked,
                });
              }
            }
          });
          formDataObj.substanceAgreements = substanceAgreements;

          // Add confirmation checkboxes
          formDataObj.confirmations = {
            avoidAgreement: document.getElementById("avoidAgreement").checked,
            substanceAgreement:
              document.getElementById("substanceAgreement").checked,
            liabilityAgreement:
              document.getElementById("liabilityAgreement").checked,
            electronicSignature: document.getElementById("electronicSignature")
              .checked,
          };

          // ======================================================================
          // [NODE_TYPE: SUBMISSION_FEEDBACK_NODE]
          // ======================================================================
          // Purpose: Show visual feedback during submission process
          // Input: Submit button and form state
          // Output: Updated UI with submission status
          console.log(
            "[SUBMISSION_FEEDBACK_NODE] Updating UI for submission in progress",
          );
          const submitButton = document.getElementById("submitButton");
          submitButton.disabled = true;
          submitButton.innerHTML =
            '<span class="spinner"></span> Submitting...';

          // Pre-close notification to improve perceived performance
          console.log("[SUBMISSION_FEEDBACK_NODE] Preparing to close WebApp");
          // Tell Telegram we're about to close (improves responsiveness)
          if (tgApp.isExpanded) {
            tgApp.expand();
          }

          // ======================================================================
          // [NODE_TYPE: DATA_SUBMISSION_NODE]
          // ======================================================================
          // Purpose: Submit form data to server and handle response
          // Input: Form data object
          // Output: Server response and WebApp closure
          console.log("[DATA_SUBMISSION_NODE] Sending data to server");

          // Send data to server
          fetch("/api/submit-waiver", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formDataObj),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log(
                "[DATA_SUBMISSION_NODE] Server response received:",
                data,
              );
              if (data.success) {
                // Success! Close immediately
                console.log(
                  "[DATA_SUBMISSION_NODE] Submission successful, closing WebApp",
                );
                // Close the WebApp and send data back to Telegram
                setTimeout(() => tgApp.close(), 100);
              } else {
                // Reset button on error
                submitButton.disabled = false;
                submitButton.textContent = "Submit Waiver Form";
                tgApp.showAlert(
                  "Error submitting form: " + (data.message || "Unknown error"),
                );
              }
            })
            .catch((error) => {
              console.error(
                "[DATA_SUBMISSION_NODE] Error submitting form:",
                error,
              );
              // Reset button on error
              submitButton.disabled = false;
              submitButton.textContent = "Submit Waiver Form";
              tgApp.showAlert("Error submitting form. Please try again.");
            });
        });
    </script>
  </body>
</html>

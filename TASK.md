# TASK.md â€“ Active Sprint Checklist

> **How to use:** Windsurf AI (or any dev) should tick a `- [ ]` when done, add notes beneath the task, and fill the Discovery & Insights sections as they learn.

## ðŸ“… Current Phase 6 â€“ Admin Essentials & Calendar Booking Activation

| ID            | Task                                                                                                       | Why / Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                      |
| :------------ | :--------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [X]**PH6â€‘01** | **Implement Admin Designation (`bin/set_admin.js`)**                                                       | (No Change) Provide a script/mechanism to assign the 'admin' role to a specific user via Telegram ID. *Pass*: Script created, accepts TG ID, updates user role to 'admin' in DB, uses core Prisma/Logger. Calls `setRoleSpecificCommands`.                                                                                                                                                                                       |
| [X]**PH6â€‘02** | **Implement Role-Based Command Router & Refine Help Command**                                                | (No Change) Implement `commandHandler.js` for role-based command routing. Update `commandRegistry.js`. Distinct `/help` for client/admin. *Pass*: Manual test shows distinct `/help` & role-based command access.                                                                                                                                                                                                                       |
| [X]**PH6â€‘03** | **Consolidate Command Handling & Deprecate `commandRouter.js`**                                              | (As previously discussed) Ensure `updateRouter.js` calls `commandHandler.handleCommand`. Verify robust role-based logic in `commandHandler.js`. Remove `src/middleware/commandRouter.js`. *Pass*: `commandRouter.js` removed. Command routing is streamlined. Manual tests pass.                                                                                                                                                    |
| [X]**PH6â€‘04** | **DB: Define `SessionType` Prisma Model & Migrate**                                                          | (No Change) Define `SessionType` model in `prisma/schema.prisma` (id, label, durationMinutes, description, price, active). Run `npx prisma migrate dev`. *Pass*: Migration successful.                                                                                                                                                                                                                                           |
| [X]**PH6â€‘05** | **DB: Populate Initial Session Types**                                                                       | (No Change) Populate `SessionType` table with initial data from `src/config/sessionTypes.json`. *Pass*: `SessionType` table contains initial data.                                                                                                                                                                                                                                                                                         |
| [X]**PH6â€‘06** | **Core: Refactor `core/sessionTypes.js` for DB Access & Add CRUD Stubs**                                       | (No Change) Update `getAll()` & `getById()` for DB. Add stub CRUD functions. *Pass*: `getAll()`, `getById()` work with DB. Unit tests pass.                                                                                                                                                                                                                                                                                               |
|               |                                                                                                            | **--- Booking Flow Overhaul Starts Here ---**                                                                                                                                                                                                                                                                                                                                                                                                    |
| [X]**PH6â€‘07** | **Tool: Enhance `telegramNotifier.sendSessionTypeSelector` (DB, 3x3 Rule)**                                  | Update tool in `src/tools/telegramNotifier.js`: Use `core/sessionTypes.getAll()` & `stateManager.getUserPastSessions`. If user has no past *completed* sessions, filter out "3x3 Kambo" (or specific ID) before creating inline keyboard. *Pass*: Selector shows correct types based on user history. Unit tests pass.                                                                                                            |
| [X]**PH6â€‘08** | **Command: Update `/book` Client Command**                                                                   | `src/commands/client/book.js` calls `telegramNotifier.sendSessionTypeSelector` (PH6-07). *Pass*: `/book` triggers role-aware session type selector.                                                                                                                                                                                                                                                                                       |
| [X]**PH6â€‘09** | **Handler: Update `callbackQueryHandler.js` for Session Selection**                                          | On `book_session:<id>` callback: Store `selectedSessionTypeId` and `telegramId` in `ctx.state` or user DB state. Use `stateManager.updateUserState` to store `edit_msg_id` of the selector message. Edit selector message to "You selected {Type}. [Book Now]" button. Button links to `/calendar-app?telegramId=X&sessionTypeId=Y`. *Pass*: Message edited, "Book Now" button links correctly.                                             |
| [X]**PH6â€‘10** | **Live GCal Read: Implement `googleCalendar.findFreeSlots` (Live)**                                          | Refactor `src/tools/googleCalendar.js` `findFreeSlots` to use `googleapis` to fetch real free/busy info. Handle OAuth2 (service account recommended). Respect practitioner's working hours & 60-day advance limit. *Pass*: Tool returns actual available slots from GCal. Requires Google Cloud setup. MCP consultation on OAuth.                                                                                             |
| [X]**PH6â€‘11** | **API: Create `GET /api/calendar/availability` Endpoint**                                                    | New Express route. Input: `startDate`, `endDate`, `sessionDurationMinutes`. Calls live `googleCalendar.findFreeSlots` (PH6-10). Returns JSON of available slots. *Pass*: Endpoint returns valid slot data. Supertest tests pass.                                                                                                                                                                                              |
| [X]**PH6â€‘12** | **API: Create `GET /api/session-types/:id` Endpoint**                                                    | New Express route. Input: `sessionTypeId`. Calls `coreSessionTypes.getById(id)`. Returns JSON of session type details. *Pass*: Endpoint returns valid session type data. Supertest tests pass. (Originally Calendar Mini-App Shell, reassigned to API endpoint)                                                                                                                                                                                              |
| [X]**PH6â€‘13**  | **Calendar Mini-App: Static Frontend Shell & Basic JS (`calendar-app.html`)** | Create `public/calendar-app.html` & `public/calendar-app.css`. <br>Layout: Header (Back arrow, "Kambo Klarity"), Frog image, Month/Year display & Nav arrows, Calendar day grid, Scrollable time slot area (3 visible, middle selected), "Booking for: [Date] at [Time] [TZ]" (initially hidden/placeholder), "Submit" button (left, initially "Select a Time"), "Cancel Booking" button (right). <br>Style: Dark theme, match visual mockup. <br>Basic JS: Parse `telegramId` & `initialSessionTypeId` from URL. "Cancel Booking" button calls `tg.close()`. <br>*Pass*: HTML/CSS matches mockup structure. JS loads params. Cancel works. |
| [X]**PH6â€‘14**  | **Calendar Mini-App: Fetch Initial Session Details & Display Availability** | `calendar-app.html` JS: <br>1. On load, use `initialSessionTypeId` to call `GET /api/session-types/:id` (PH6-12) to get `label` & `durationMinutes`. <br>2. Call `GET /api/calendar/availability` (PH6-11) using this `durationMinutes` for current month. <br>3. Render returned UTC slots in the scrollable time slot UI (middle one highlighted, convert to user's local time for display). <br>4. Implement Prev/Next month buttons to re-fetch availability. <br>5. When a slot is clicked: update "Booking for..." text, enable "Submit" button (text "Book for {Time}"). <br>*Pass*: Calendar displays slots for initial session type. Month nav works. Slot selection updates UI. **COMPLETE** - Enhanced with video background support, static positioning, and UI refinements. |


## ðŸ§ª Testing Overhaul

| ID            | Task                                       | Why / Acceptance Criteria                                                                                                                                                              |
| :------------ | :----------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [ ]**PH_TEST-01** | **Integrate Jest Testing Framework** | Replace Mocha with Jest. Configure Jest for the project. Define unit and integration testing strategy. Install dependencies, update package.json scripts. Create initial test structure. |

| [X]**PH_TEST-01.7** | **Create Initial Unit Test for `src/tools/telegramNotifier.js`** | 2025-05-20: Create `tests/tools/telegramNotifier.test.js` with initial mock structure and TODOs for `telegramNotifier.js` functions. Aligns with JEST_INTEGRATION_PLAN.md Phase 2, Step 7. |
---
| [X]**PH_TEST-02** | **Run tests for env.test.js** | 2025-05-20: Execute npm test to verify changes in tests/core/env.test.js. Report outcome. |


### Discovered During Work (Phase 6)

- **PH6-D1 (PH6-05):** Initial implementation of `sessionTypes.js` CRUD operations targeted basic create, read (all/by ID), update, and a soft delete (`deleteTypeOrDeactivate`).
- **PH6-D2 (PH6-05):** Created `bin/test_sessionTypes_module.js` to perform manual end-to-end testing of these CRUD functions against the live database.
- **PH6-D3 (PH6-05):** Identified a `TypeError` during testing related to logger instantiation in `src/core/prisma.js`. Corrected by ensuring the main app logger was imported and a child logger created for Prisma.
- **PH6-D4 (PH6-05):** Refined Prisma client shutdown handlers in `src/core/prisma.js` for more robust error logging and graceful disconnection.
- **PH6-D5 (PH6-05):** Based on testing and requirements clarification, evolved `sessionTypes.js`:
    - Renamed `deleteTypeOrDeactivate` to `deactivateType` for clarity (still performs soft delete by setting `active: false`).
    - Added `reactivateType(id)` to set `active: true`.
    - Added `deleteType(id)` for actual hard deletion of records from the database.
- **PH6-D6 (PH6-05):** Updated `bin/test_sessionTypes_module.js` to cover the full lifecycle: create -> read -> update -> read -> deactivate -> read (inactive) -> reactivate -> read (active) -> delete (hard) -> read (verify null).
- **(PH6-10):** Implemented full `findFreeSlots` logic in `googleCalendar.js`. Discovered complexities in handling timezones (practitioner vs. UTC), date math with `date-fns` and `date-fns-tz` (especially ensuring correct day boundaries and earliest booking times in practitioner's timezone), and nuances of Google Calendar API for fetching events within specific time ranges. The `slot_increment_minutes` from `AvailabilityRule` was integrated. Extensive debugging logs (`[SlotGenDebug]`) were added for traceability. The `max_bookings_per_day` rule was refined to only check existing GCal bookings, not limit the display of *available* slots.
- **(PH6-11):** Ensured `GoogleCalendarTool` dependency injection was correctly configured in [`src/app.js`](src/app.js) and [`src/handlers/apiHandler.js`](src/handlers/apiHandler.js). Initial plan included integration tests, but these were skipped based on user feedback during the process.
- **(PH6-12):** Implemented the `GET /api/session-types/:id` endpoint. To maintain code organization and adhere to file length limits, the handler logic was placed in a new file: [`src/handlers/api/sessionTypesApiHandler.js`](src/handlers/api/sessionTypesApiHandler.js:1). The main API router ([`src/routes/api.js`](src/routes/api.js:1)) was updated to use this new handler. The process involved standard linting and formatting, and a minor fix for an unused variable (`next` changed to `_next`) in the handler.
- **(PH6-13):** Created the complete calendar mini-app frontend shell (`public/calendar-app.html`) with dark theme styling using Tailwind CSS. Key features implemented: Telegram WebApp integration with parameter parsing (`telegramId`, `sessionTypeId`), frog image header with proper background positioning, month/year navigation controls, 7-day calendar grid layout, scrollable time slot picker with gradient highlighting effects (3 visible slots with center selection), booking summary section, and dual action buttons (Submit/Cancel). Added sophisticated scroll-based highlighting system for time slots with CSS masking for fade effects. Integrated Telegram WebApp SDK with proper initialization, back button handling, and close functionality. The layout is fully responsive and matches the dark theme mockup requirements.
- **(PH6-14):** Completed the dynamic calendar functionality in `public/calendar-app.js` (479 lines). Implemented comprehensive API integration with session type fetching (`GET /api/session-types/:id`) and availability data loading (`GET /api/calendar/availability`). Key discoveries: Complex timezone handling for UTC API data to local display conversion; sophisticated scroll-based time slot highlighting with gradient effects and auto-selection when scrolling stops; dynamic calendar grid rendering with availability indicators (muted grey-green for available days); month navigation with automatic API re-fetching; comprehensive error handling and loading states; mobile-optimized UX with touch interaction tracking. Significant UX refinements through multiple iterations: reduced visual gaps, improved color schemes (bright green submit button, muted available day indicators), intuitive time selection (scroll-to-select eliminating tap requirement), conditional UI visibility (time picker only shows after date selection), and consistent button states. The implementation successfully integrates all backend APIs while maintaining file size compliance and providing a polished, mobile-first user experience ready for booking submission integration.
- **(PH6-14 Performance & UX Optimization):** Addressed performance bottlenecks and UX issues through comprehensive optimization. Eliminated 3-4 second loading delays via progressive loading strategy and intelligent caching. Fixed critical calendar month switching bug causing 4-day date offset. Implemented modular architecture splitting monolithic 813-line file into focused modules (`calendar-api.js` for API/caching, `calendar-app.js` for UI logic). Enhanced user interaction model: booking info only appears when valid time slots are available and centered during scroll; submit button enables immediately on date selection; final validation occurs only on submission to prevent false "slot taken" messages during browsing. Achieved layout stability by using `visibility` properties instead of `display` changes to prevent jarring UI movements. Result: Instant calendar display, reliable conflict detection, and polished mobile-first user experience.

## ðŸŽ¨ **PH6-16: Calendar & Waiver Flow Styling & UX Enhancements**

**(Stagewise Toolbar Integration):** Successfully integrated the Stagewise AI-powered development toolbar across all forms (waiver, registration, calendar). The toolbar enables real-time AI-assisted editing through browser interaction. Key implementation details: ES module loading with process polyfill for browser compatibility; development-only loading (localhost, ngrok, tunnel URLs); enhanced configuration with custom plugins for Kambo context; visual feedback with "Stagewise Active" notifications. The toolbar allows users to select page elements and request changes that can be implemented by AI agents, significantly improving the development workflow.

**(Video Background Stability):** Fixed critical mobile UX issue where background video would resize when keyboard appeared on mobile devices. Implemented CSS solutions using `height: 100vh`, `min-height: 100vh`, and viewport management to ensure video maintains consistent size regardless of keyboard state. Added HTML and body overflow controls to prevent viewport resizing during keyboard interactions.

**(Waiver Form UX Improvements):** Comprehensive mobile-first redesign of the waiver form with focus on accessibility and usability:
- **Enhanced Checkbox Interaction:** Increased checkbox sizes (20px standard, 24px for substance table) with larger touch targets (16px padding) for better mobile accessibility
- **Visual Feedback:** Added permanent subtle background highlighting (`rgba(255, 255, 255, 0.05)`) to all form sections for better visual hierarchy
- **Improved Layout:** Restructured agreement checkboxes to appear below text instead of beside it for better readability
- **Substance Guidelines Table:** Fixed column spacing with equal distribution (45% substance, 15% prior, 15% post, 25% agreement), centered checkboxes under "Agreement" column, added proper text wrapping to prevent overflow
- **Clear Instructions:** Added explicit instructions for substance guidelines: "Please check each box for substances that you agree NOT to use within the specified time periods"
- **Form Input Styling:** Updated all form controls to use semi-transparent backgrounds instead of white, maintaining theme consistency

**(Calendar App Enhancements):** Fixed frog positioning issue by changing from viewport-relative (`fixed`) to container-relative (`absolute`) positioning, ensuring the frog remains static relative to the background regardless of screen resizing. Brightened background video by reducing overlay opacity from 0.2 to 0.1 for better visibility.

**(Code Quality & Maintenance):** Updated ESLint configuration to properly ignore build directories (`.next/`), fixed lint errors including unused variable declarations, and maintained file size compliance throughout all changes. All styling changes were implemented in the shared `calendar-theme.css` file for consistency across the application.

**Result:** Significantly improved mobile user experience with stable video backgrounds, accessible form interactions, clear visual hierarchy, and professional styling that maintains the dark theme aesthetic while ensuring usability across all devices.

### Summary (Phase 6)

*Summary of changes and decisions.*

- **(PH6â€‘02):** Implement `commandHandler.js` (or `commandRouter.js`) to handle role-based command routing. Update `commandRegistry.js`. Distinct `/help` for client/admin. *Pass*: Tests pass. Manual test shows distinct `/help` & role-based command access (admin can use admin commands, client cannot).                                                                                                                
- **(PH6-04, PH6-05):** Transitioned `SessionType` management from a static JSON file to direct Prisma database integration. This was a key step to enable dynamic management of session types by administrators and to lay the groundwork for more complex booking and scheduling features. The direct DB approach ensures data consistency and avoids manual file updates.
- **(PH6-06):** Implemented a comprehensive CRUD (Create, Read, Update, Delete) cycle for `SessionType` entities. This included evolving the 'delete' functionality to distinguish between soft-deletion (deactivation, setting `active: false`) and hard-deletion (permanent removal from DB). Also added a `reactivateType` function. This provides flexibility for data retention policies and administrative control, while ensuring test data can be cleanly removed.
- **(PH6-05):** Utilized a temporary, command-line test script (`bin/test_sessionTypes_module.js`) for rapid, iterative manual testing of the `sessionTypes.js` module against a live database. This allowed for quick verification of each CRUD operation and its database impact before integrating with more complex parts of the system like agents or bot commands.
- **(PH6-07):** Database Changes:
Removed conversation_history and current_action fields from the users table
Added can_book_3x3 field to the users table with a default value of false
- **(PH6-07):** Webhook Management:
Created a new bin/set_webhook.js utility script for manual webhook setup
Updated app.js to remove automatic webhook setting and polling
Added a new npm script webhook:set to run the webhook utility
Fixed a case mismatch in the ngrokUrl reference in server.js
- **(PH6-07):** Session Type Filtering:
Updated stateManager.getUserProfileData to include the can_book_3x3 field
Modified telegramNotifier.sendSessionTypeSelector to filter session types based on the user's permission
Added logic to filter out the "3hr-kambo" session type for users without permission
- **(PH6-10):** Successfully implemented the full logic for `findFreeSlots` in `src/tools/googleCalendar.js`, integrating live Google Calendar API calls. This involved: fetching practitioner availability rules and timezone from the database; correctly calculating earliest booking time and maximum booking date based on these rules and current time; iterating through days and rule blocks in the practitioner's timezone; generating potential slots based on `slot_increment_minutes`; checking against existing Kambo session and personal calendar events (with `buffer_time_minutes`); and correctly handling the `max_bookings_per_day` rule by only considering existing bookings. The process highlighted the importance of meticulous timezone conversions (UTC to/from practitioner's timezone) and careful date arithmetic using `date-fns` and `date-fns-tz`. Extensive `[SlotGenDebug]` logging was added to trace slot generation and conflict checks, proving invaluable for debugging.
- **(PH6-11):** Implemented the `GET /api/calendar/availability` endpoint on the `feat/PH6-11-Calendar-Api` branch. This provides functionality to retrieve available calendar slots. Key files modified: [`src/app.js`](src/app.js), [`src/handlers/apiHandler.js`](src/handlers/apiHandler.js), [`src/routes/api.js`](src/routes/api.js).
- **(PH6-12):** Successfully created the `GET /api/session-types/:id` endpoint on the `feat/PH6-12-session-type-api` branch (commit `096442f`). This endpoint allows the frontend calendar application to retrieve detailed information about a specific session type (e.g., label, durationMinutes) using its ID. The implementation included creating a new handler file ([`src/handlers/api/sessionTypesApiHandler.js`](src/handlers/api/sessionTypesApiHandler.js:1)) and updating the API router ([`src/routes/api.js`](src/routes/api.js:1)).
- **(PH6-13):** Created the complete calendar mini-app frontend shell (`public/calendar-app.html`) with dark theme styling using Tailwind CSS. Key features implemented: Telegram WebApp integration with parameter parsing (`telegramId`, `sessionTypeId`), frog image header with proper background positioning, month/year navigation controls, 7-day calendar grid layout, scrollable time slot picker with gradient highlighting effects (3 visible slots with center selection), booking summary section, and dual action buttons (Submit/Cancel). Added sophisticated scroll-based highlighting system for time slots with CSS masking for fade effects. Integrated Telegram WebApp SDK with proper initialization, back button handling, and close functionality. The layout is fully responsive and matches the dark theme mockup requirements.
- **(PH6-14):** Completed the dynamic calendar functionality in `public/calendar-app.js` (479 lines). Implemented comprehensive API integration with session type fetching (`GET /api/session-types/:id`) and availability data loading (`GET /api/calendar/availability`). Key discoveries: Complex timezone handling for UTC API data to local display conversion; sophisticated scroll-based time slot highlighting with gradient effects and auto-selection when scrolling stops; dynamic calendar grid rendering with availability indicators (muted grey-green for available days); month navigation with automatic API re-fetching; comprehensive error handling and loading states; mobile-optimized UX with touch interaction tracking. Significant UX refinements through multiple iterations: reduced visual gaps, improved color schemes (bright green submit button, muted available day indicators), intuitive time selection (scroll-to-select eliminating tap requirement), conditional UI visibility (time picker only shows after date selection), and consistent button states. The implementation successfully integrates all backend APIs while maintaining file size compliance and providing a polished, mobile-first user experience ready for booking submission integration.

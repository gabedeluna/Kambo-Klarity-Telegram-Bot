# TASK.md â€“ Active Sprint Checklist

> **How to use:** Windsurf AI (or any dev) should tick a `- [ ]` when done, add notes beneath the task, and fill the Discovery & Insights sections as they learn.

## ðŸ“… Current Phase 6 â€“ Admin Essentials & Calendar Booking Activation

| ID            | Task                                                                                                       | Why / Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                      |
| :------------ | :--------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [X]**PH6â€‘01** | **Implement Admin Designation (`bin/set_admin.js`)**                                                       | (No Change) Provide a script/mechanism to assign the 'admin' role to a specific user via Telegram ID. *Pass*: Script created, accepts TG ID, updates user role to 'admin' in DB, uses core Prisma/Logger. Calls `setRoleSpecificCommands`.                                                                                                                                                                                       |
| [X]**PH6â€‘02** | **Implement Role-Based Command Router & Refine Help Command**                                                | (No Change) Implement `commandHandler.js` for role-based command routing. Update `commandRegistry.js`. Distinct `/help` for client/admin. *Pass*: Manual test shows distinct `/help` & role-based command access.                                                                                                                                                                                                                       |
| [X]**PH6â€‘03** | **Consolidate Command Handling & Deprecate `commandRouter.js`**                                              | (As previously discussed) Ensure `updateRouter.js` calls `commandHandler.handleCommand`. Verify robust role-based logic in `commandHandler.js`. Remove `src/middleware/commandRouter.js`. *Pass*: `commandRouter.js` removed. Command routing is streamlined. Manual tests pass.                                                                                                                                                    |
| [X]**PH6â€‘04** | **DB: Define `SessionType` Prisma Model & Migrate**                                                          | (No Change) Define `SessionType` model in `prisma/schema.prisma` (id, label, durationMinutes, description, price, active). Run `npx prisma migrate dev`. *Pass*: Migration successful.                                                                                                                                                                                                                                           |
| [X]**PH6â€‘05** | **DB: Populate Initial Session Types**                                                                       | (No Change) Populate `SessionType` table with initial data from `src/config/sessionTypes.json`. *Pass*: `SessionType` table contains initial data.                                                                                                                                                                                                                                                                                         |
| [X]**PH6â€‘06** | **Core: Refactor `core/sessionTypes.js` for DB Access & Add CRUD Stubs**                                       | (No Change) Update `getAll()` & `getById()` for DB. Add stub CRUD functions. *Pass*: `getAll()`, `getById()` work with DB. Unit tests pass.                                                                                                                                                                                                                                                                                               |
|               |                                                                                                            | **--- Booking Flow Overhaul Starts Here ---**                                                                                                                                                                                                                                                                                                                                                                                                    |
| [X]**PH6â€‘07** | **Tool: Enhance `telegramNotifier.sendSessionTypeSelector` (DB, 3x3 Rule)**                                  | Update tool in `src/tools/telegramNotifier.js`: Use `core/sessionTypes.getAll()` & `stateManager.getUserPastSessions`. If user has no past *completed* sessions, filter out "3x3 Kambo" (or specific ID) before creating inline keyboard. *Pass*: Selector shows correct types based on user history. Unit tests pass.                                                                                                            |
| [X]**PH6â€‘08** | **Command: Update `/book` Client Command**                                                                   | `src/commands/client/book.js` calls `telegramNotifier.sendSessionTypeSelector` (PH6-07). *Pass*: `/book` triggers role-aware session type selector.                                                                                                                                                                                                                                                                                       |
| [X]**PH6â€‘09** | **Handler: Update `callbackQueryHandler.js` for Session Selection**                                          | On `book_session:<id>` callback: Store `selectedSessionTypeId` and `telegramId` in `ctx.state` or user DB state. Use `stateManager.updateUserState` to store `edit_msg_id` of the selector message. Edit selector message to "You selected {Type}. [Book Now]" button. Button links to `/calendar-app?telegramId=X&sessionTypeId=Y`. *Pass*: Message edited, "Book Now" button links correctly.                                             |
| [X]**PH6â€‘10** | **Live GCal Read: Implement `googleCalendar.findFreeSlots` (Live)**                                          | Refactor `src/tools/googleCalendar.js` `findFreeSlots` to use `googleapis` to fetch real free/busy info. Handle OAuth2 (service account recommended). Respect practitioner's working hours & 60-day advance limit. *Pass*: Tool returns actual available slots from GCal. Requires Google Cloud setup. MCP consultation on OAuth.                                                                                             |
| [X]**PH6â€‘11** | **API: Create `GET /api/calendar/availability` Endpoint**                                                    | New Express route. Input: `startDate`, `endDate`, `sessionDurationMinutes`. Calls live `googleCalendar.findFreeSlots` (PH6-10). Returns JSON of available slots. *Pass*: Endpoint returns valid slot data. Supertest tests pass.                                                                                                                                                                                              |
| [X]**PH6â€‘12** | **API: Create `GET /api/session-types/:id` Endpoint**                                                    | New Express route. Input: `sessionTypeId`. Calls `coreSessionTypes.getById(id)`. Returns JSON of session type details. *Pass*: Endpoint returns valid session type data. Supertest tests pass. (Originally Calendar Mini-App Shell, reassigned to API endpoint)                                                                                                                                                                                              |
| [ ]**PH6â€‘13** | **Calendar Mini-App: JS to Fetch & Display Availability**                                                    | `calendar-app.html` JS: Call `GET /api/calendar/availability`. Render slots on UI (simple library or custom). Handle month navigation (re-fetch). Highlight selectable slots. *Pass*: Calendar displays available slots from GCal. User can navigate months.                                                                                                                                                                         |
| [ ]**PH6â€‘14** | **Calendar Mini-App: Dynamic Session Type Selector (3x3 Rule, Re-fetch)**                                    | `calendar-app.html` JS: Session type selector. Fetch types from DB (new `GET /api/session-types` or reuse `core/sessionTypes.js` if FE can access). Fetch user past sessions (new `GET /api/users/:id/past-sessions` or reuse `stateManager`). Filter "3x3 Kambo" based on history. Changing session type re-fetches availability if duration differs. *Pass*: Selector works, respects rules, re-fetches slots. |
| [ ]**PH6â€‘15** | **API: Create `POST /api/calendar/book-slot` Endpoint**                                                      | New Express route. Input: `telegramId`, `sessionTypeId`, `appointmentDateTimeISO`. Handler: Creates `Session` in Prisma (status `PENDING_WAIVER`). Retrieves `edit_msg_id` (from selector message, stored by PH6-09). Calls `telegramNotifier.sendWaiverLink` (modified: takes `sessionId`, `editMsgId`; sends "Booking for {Type} on {Date} held. [Complete Waiver]" button; updates `edit_msg_id`). Notifies admin. *Pass*: Session created, message edited, admin notified. Supertest tests pass. |
| [ ]**PH6â€‘16** | **Tool: Modify `telegramNotifier.sendWaiverLink`**                                                         | Update `sendWaiverLink` to accept `sessionId` and the current `editMsgId`. The URL for waiver button becomes `/waiver-form.html?telegramId=X&sessionType=Y&sessionId=Z`. It must return the *new* message ID of the waiver link message, so this can be stored for the next edit. *Pass*: Tool sends correct waiver link and facilitates `edit_msg_id` update. Unit tests pass. |
| [ ]**PH6â€‘17** | **Calendar Mini-App: JS to Handle Slot Selection & Submit Booking**                                          | `calendar-app.html` JS: On slot click -> confirm -> call `POST /api/calendar/book-slot`. On success, `tg.close()`. Handle "Cancel" button (e.g., `tg.close()` or navigate back). *Pass*: Booking submitted from calendar, app closes.                                                                                                                                                                                           |
| [ ]**PH6â€‘18** | **Waiver: Enhance Submission Logic for Existing Session**                                                    | Modify `apiHandler.submitWaiverApi`: Accepts `sessionId`. Updates *existing* `Session` with `liability_form_data`, sets status (e.g. `WAIVER_SUBMITTED`). Retrieves `edit_msg_id` (from waiver link message, stored by PH6-15 via PH6-16). Calls `telegramNotifier` to edit waiver link msg to "Thanks for submitting..." (no button). Notifies admin ("Waiver submitted..."). *Pass*: Waiver updates DB, msg edited, admin notified. |
| [ ]**PH6â€‘19** | **Command: Implement `/sessions` Admin Command (View Only)**                                                 | (No Change from original PH6) Create `src/commands/admin/sessions.js`. Handler queries `prisma.sessions`, replies with list. *Pass*: Admin can view sessions.                                                                                                                                                                                                                                                    |
| [ ]**PH6â€‘20** | **Command: Implement `/dashboard` Admin Command (WebApp Button)**                                              | (No Change from original PH6) Create `src/commands/admin/dashboard.js`. Handler replies with WebApp button. *Pass*: Admin receives button.                                                                                                                                                                                                                                                                         |
| [ ]**PH6â€‘21** | **Placeholder: Implement Daily Appointment Reminder Automation**                                             | Create stub/placeholder for a daily cron job (`src/automations/appointmentReminders.js`) that would query upcoming sessions and send reminders. Full implementation deferred. *Pass*: Stub file exists, basic structure outlined.                                                                                                                                                                             |
| [ ]**PH6â€‘22** | **Test Coverage & Documentation for New Phase 6**                                                            | Ensure new/modified Phase 6 modules meet coverage targets. Add JSDoc. Write/update manual test plans for the new calendar booking flow. *Pass*: Coverage target met. Docs updated. Test plans exist.                                                                                                                                                                                                       |
| [ ]**PH6â€‘23** | **Update `PLANNING.MD` & `docs/architecture.md` for Booking Flow Change**                                    | Significantly revise `PLANNING.MD` section 5 (Phase 6.3) and section 11 to reflect the new calendar mini-app booking flow. Update `architecture.md` diagrams/descriptions. *Pass*: Docs accurately reflect the new design.                                                                                                                                                                             |
| [ ]**PH6â€‘24** | **Final Review & TASK.md Updates for New Phase 6**                                                           | Tick all Phase 6 task boxes. Ensure Discoveries/Insights are recorded. *Pass*: All Phase 6 tasks in `TASK.MD` checked.                                                                                                                                                                |

## ðŸ§ª Testing Overhaul

| ID            | Task                                       | Why / Acceptance Criteria                                                                                                                                                              |
| :------------ | :----------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [ ]**PH_TEST-01** | **Integrate Jest Testing Framework** | Replace Mocha with Jest. Configure Jest for the project. Define unit and integration testing strategy. Install dependencies, update package.json scripts. Create initial test structure. |

| [X]**PH_TEST-01.7** | **Create Initial Unit Test for `src/tools/telegramNotifier.js`** | 2025-05-20: Create `tests/tools/telegramNotifier.test.js` with initial mock structure and TODOs for `telegramNotifier.js` functions. Aligns with JEST_INTEGRATION_PLAN.md Phase 2, Step 7. |
---
| [X]**PH_TEST-02** | **Run tests for env.test.js** | 2025-05-20: Execute npm test to verify changes in tests/core/env.test.js. Report outcome. |


### Discovered During Work (Phase 6)

- **PH6-D1 (PH6-05):** Initial implementation of `sessionTypes.js` CRUD operations targeted basic create, read (all/by ID), update, and a soft delete (`deleteTypeOrDeactivate`).
- **PH6-D2 (PH6-05):** Created `bin/test_sessionTypes_module.js` to perform manual end-to-end testing of these CRUD functions against the live database.
- **PH6-D3 (PH6-05):** Identified a `TypeError` during testing related to logger instantiation in `src/core/prisma.js`. Corrected by ensuring the main app logger was imported and a child logger created for Prisma.
- **PH6-D4 (PH6-05):** Refined Prisma client shutdown handlers in `src/core/prisma.js` for more robust error logging and graceful disconnection.
- **PH6-D5 (PH6-05):** Based on testing and requirements clarification, evolved `sessionTypes.js`:
    - Renamed `deleteTypeOrDeactivate` to `deactivateType` for clarity (still performs soft delete by setting `active: false`).
    - Added `reactivateType(id)` to set `active: true`.
    - Added `deleteType(id)` for actual hard deletion of records from the database.
- **PH6-D6 (PH6-05):** Updated `bin/test_sessionTypes_module.js` to cover the full lifecycle: create -> read -> update -> read -> deactivate -> read (inactive) -> reactivate -> read (active) -> delete (hard) -> read (verify null).
- **(PH6-10):** Implemented full `findFreeSlots` logic in `googleCalendar.js`. Discovered complexities in handling timezones (practitioner vs. UTC), date math with `date-fns` and `date-fns-tz` (especially ensuring correct day boundaries and earliest booking times in practitioner's timezone), and nuances of Google Calendar API for fetching events within specific time ranges. The `slot_increment_minutes` from `AvailabilityRule` was integrated. Extensive debugging logs (`[SlotGenDebug]`) were added for traceability. The `max_bookings_per_day` rule was refined to only check existing GCal bookings, not limit the display of *available* slots.
- **(PH6-11):** Ensured `GoogleCalendarTool` dependency injection was correctly configured in [`src/app.js`](src/app.js) and [`src/handlers/apiHandler.js`](src/handlers/apiHandler.js). Initial plan included integration tests, but these were skipped based on user feedback during the process.
- **(PH6-12):** Implemented the `GET /api/session-types/:id` endpoint. To maintain code organization and adhere to file length limits, the handler logic was placed in a new file: [`src/handlers/api/sessionTypesApiHandler.js`](src/handlers/api/sessionTypesApiHandler.js:1). The main API router ([`src/routes/api.js`](src/routes/api.js:1)) was updated to use this new handler. The process involved standard linting and formatting, and a minor fix for an unused variable (`next` changed to `_next`) in the handler.

### Summary (Phase 6)

*Summary of changes and decisions.*

- **(PH6â€‘02):** Implement `commandHandler.js` (or `commandRouter.js`) to handle role-based command routing. Update `commandRegistry.js`. Distinct `/help` for client/admin. *Pass*: Tests pass. Manual test shows distinct `/help` & role-based command access (admin can use admin commands, client cannot).                                                                                                                
- **(PH6-04, PH6-05):** Transitioned `SessionType` management from a static JSON file to direct Prisma database integration. This was a key step to enable dynamic management of session types by administrators and to lay the groundwork for more complex booking and scheduling features. The direct DB approach ensures data consistency and avoids manual file updates.
- **(PH6-06):** Implemented a comprehensive CRUD (Create, Read, Update, Delete) cycle for `SessionType` entities. This included evolving the 'delete' functionality to distinguish between soft-deletion (deactivation, setting `active: false`) and hard-deletion (permanent removal from DB). Also added a `reactivateType` function. This provides flexibility for data retention policies and administrative control, while ensuring test data can be cleanly removed.
- **(PH6-05):** Utilized a temporary, command-line test script (`bin/test_sessionTypes_module.js`) for rapid, iterative manual testing of the `sessionTypes.js` module against a live database. This allowed for quick verification of each CRUD operation and its database impact before integrating with more complex parts of the system like agents or bot commands.
- **(PH6-07):** Database Changes:
Removed conversation_history and current_action fields from the users table
Added can_book_3x3 field to the users table with a default value of false
- **(PH6-07):** Webhook Management:
Created a new bin/set_webhook.js utility script for manual webhook setup
Updated app.js to remove automatic webhook setting and polling
Added a new npm script webhook:set to run the webhook utility
Fixed a case mismatch in the ngrokUrl reference in server.js
- **(PH6-07):** Session Type Filtering:
Updated stateManager.getUserProfileData to include the can_book_3x3 field
Modified telegramNotifier.sendSessionTypeSelector to filter session types based on the user's permission
Added logic to filter out the "3hr-kambo" session type for users without permission
- **(PH6-10):** Successfully implemented the full logic for `findFreeSlots` in `src/tools/googleCalendar.js`, integrating live Google Calendar API calls. This involved: fetching practitioner availability rules and timezone from the database; correctly calculating earliest booking time and maximum booking date based on these rules and current time; iterating through days and rule blocks in the practitioner's timezone; generating potential slots based on `slot_increment_minutes`; checking against existing Kambo session and personal calendar events (with `buffer_time_minutes`); and correctly handling the `max_bookings_per_day` rule by only considering existing bookings. The process highlighted the importance of meticulous timezone conversions (UTC to/from practitioner's timezone) and careful date arithmetic using `date-fns` and `date-fns-tz`. Extensive `[SlotGenDebug]` logging was added to trace slot generation and conflict checks, proving invaluable for debugging.
- **(PH6-11):** Implemented the `GET /api/calendar/availability` endpoint on the `feat/PH6-11-Calendar-Api` branch. This provides functionality to retrieve available calendar slots. Key files modified: [`src/app.js`](src/app.js), [`src/handlers/apiHandler.js`](src/handlers/apiHandler.js), [`src/routes/api.js`](src/routes/api.js).
- **(PH6-12):** Successfully created the `GET /api/session-types/:id` endpoint on the `feat/PH6-12-session-type-api` branch (commit `096442f`). This endpoint allows the frontend calendar application to retrieve detailed information about a specific session type (e.g., label, durationMinutes) using its ID. The implementation included creating a new handler file ([`src/handlers/api/sessionTypesApiHandler.js`](src/handlers/api/sessionTypesApiHandler.js:1)) and updating the API router ([`src/routes/api.js`](src/routes/api.js:1)).
```                                                  |
| [ ]**PH_TEST-01** | **Integrate Jest Testing Framework** | 2025-05-20: Replace Mocha with Jest. Configure Jest for the project. Define unit and integration testing strategy. Install dependencies, update package.json scripts. Create initial test structure. |
